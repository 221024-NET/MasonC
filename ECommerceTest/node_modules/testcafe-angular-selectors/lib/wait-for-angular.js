'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _testcafe = require('testcafe');

exports.default = (0, _testcafe.ClientFunction)(function (ms) {
    return new Promise(function (resolve, reject) {
        var pingIntervalId = null;
        var pingTimeoutId = null;
        var WAIT_TIMEOUT = ms || 10000;
        var PING_INTERVAL = 100;

        var clearTimeouts = function clearTimeouts() {
            window.clearTimeout(pingTimeoutId);
            window.clearInterval(pingIntervalId);
        };

        var getFirstRootElement = function getFirstRootElement() {
            if (typeof window.getAllAngularRootElements === 'function') {
                var rootElements = window.getAllAngularRootElements();

                return rootElements && rootElements.length ? rootElements[0] : null;
            }

            return null;
        };

        var isElementInjectorExists = function isElementInjectorExists(firstRootElement) {
            if (window.ng) {
                // NOTE: Angular version 9 or higher
                if (typeof window.ng.getInjector === 'function') {
                    var firstRootInjector = window.ng.getInjector(firstRootElement);
                    var injectorConstructorName = firstRootInjector && firstRootInjector.constructor && firstRootInjector.constructor.name;

                    return !!injectorConstructorName && injectorConstructorName.toLowerCase() === 'nodeinjector';
                }
                // NOTE: Angular version 8 or lower
                else if (typeof window.ng.probe === 'function') {
                        var firstRootDebugElement = window.ng.probe(firstRootElement);

                        return !!(firstRootDebugElement && firstRootDebugElement.injector);
                    }
            }

            return false;
        };

        var isThereAngularInDevelopmentMode = function isThereAngularInDevelopmentMode() {
            var firstRootElement = getFirstRootElement();

            return !!firstRootElement && isElementInjectorExists(firstRootElement);
        };

        var check = function check() {
            if (isThereAngularInDevelopmentMode()) {
                clearTimeouts();
                resolve();
            }
        };

        pingTimeoutId = window.setTimeout(function () {
            clearTimeouts();
            reject(new Error(`Cannot find information about Angular components. The tested application should be deployed in development mode.
                              For more information, see https://angular.io/guide/deployment.`));
        }, WAIT_TIMEOUT);

        check();
        pingIntervalId = window.setInterval(check, PING_INTERVAL);
    });
}); /*global Promise*/